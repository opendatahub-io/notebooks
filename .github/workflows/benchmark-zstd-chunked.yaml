name: Benchmark zstd:chunked vs gzip image pulls

on:
  workflow_dispatch:
  push:
    branches:
      - 'benchmark/zstd-chunked-pulls'

env:
  # zstd:chunked images from PR #2868 (after convert-compression step)
  # Layer mediaType: application/vnd.oci.image.layer.v1.tar+zstd
  ZSTD_CPU_C9S: "quay.io/opendatahub/odh-base-image-cpu-py312-c9s:on-pr-092c6459c5405027594ea964d53ba3419ac50e5d"
  ZSTD_CPU_UBI9: "quay.io/opendatahub/odh-base-image-cpu-py312-ubi9:on-pr-092c6459c5405027594ea964d53ba3419ac50e5d"
  ZSTD_CUDA_C9S: "quay.io/opendatahub/odh-base-image-cuda-py312-c9s:on-pr-092c6459c5405027594ea964d53ba3419ac50e5d"
  
  # Same images BEFORE convert-compression (gzip from build-image-index step)
  # Layer mediaType: application/vnd.docker.image.rootfs.diff.tar.gzip
  # These are the intermediate tags that Konflux creates before conversion
  GZIP_CPU_C9S: "quay.io/opendatahub/odh-base-image-cpu-py312-c9s:odh-base-imagdb6789fe4a552eed5f7a284a8ef1c16f-build-image-index"
  GZIP_CPU_UBI9: "quay.io/opendatahub/odh-base-image-cpu-py312-ubi9:odh-base-imag1448bfb0db7888075ea7a7e5c42e3f1f-build-image-index"
  GZIP_CUDA_C9S: "quay.io/opendatahub/odh-base-image-cuda-py312-c9s:odh-base-image1635032e0b94178a149746d1675d52c-build-image-index"

jobs:
  benchmark-pull-times:
    name: Benchmark Pull Times
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          # Install crane for image inspection
          curl -sL https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz | tar xzf - crane
          sudo mv crane /usr/local/bin/
          
          # Configure podman for partial pulls
          mkdir -p ~/.config/containers
          cat > ~/.config/containers/storage.conf << 'EOF'
          [storage]
          driver = "overlay"
          
          [storage.options.pull_options]
          enable_partial_images = "true"
          use_hard_links = "false"
          EOF

      - name: Get image sizes
        run: |
          echo "## Image Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | gzip (original) | zstd:chunked | Savings |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------------|--------------|---------|" >> $GITHUB_STEP_SUMMARY
          
          get_total_layer_size() {
            local image="$1"
            # For manifest lists, get first manifest and sum layer sizes
            MANIFEST=$(crane manifest "$image" 2>/dev/null)
            if echo "$MANIFEST" | jq -e '.manifests' >/dev/null 2>&1; then
              # It's a manifest list, get first architecture
              DIGEST=$(echo "$MANIFEST" | jq -r '.manifests[0].digest')
              REPO=$(echo "$image" | cut -d@ -f1 | cut -d: -f1)
              crane manifest "${REPO}@${DIGEST}" 2>/dev/null | jq '[.layers[].size] | add // 0'
            else
              # Single manifest
              echo "$MANIFEST" | jq '[.layers[].size] | add // 0'
            fi
          }
          
          # CPU C9S comparison
          GZIP_SIZE=$(get_total_layer_size "$GZIP_CPU_C9S")
          ZSTD_SIZE=$(get_total_layer_size "$ZSTD_CPU_C9S")
          if [ "$GZIP_SIZE" -gt 0 ] && [ "$ZSTD_SIZE" -gt 0 ]; then
            SAVINGS=$((100 - (ZSTD_SIZE * 100 / GZIP_SIZE)))
            echo "| CPU C9S | $(numfmt --to=iec $GZIP_SIZE) | $(numfmt --to=iec $ZSTD_SIZE) | ${SAVINGS}% smaller |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CPU C9S | N/A | N/A | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # CPU UBI9 comparison
          GZIP_SIZE=$(get_total_layer_size "$GZIP_CPU_UBI9")
          ZSTD_SIZE=$(get_total_layer_size "$ZSTD_CPU_UBI9")
          if [ "$GZIP_SIZE" -gt 0 ] && [ "$ZSTD_SIZE" -gt 0 ]; then
            SAVINGS=$((100 - (ZSTD_SIZE * 100 / GZIP_SIZE)))
            echo "| CPU UBI9 | $(numfmt --to=iec $GZIP_SIZE) | $(numfmt --to=iec $ZSTD_SIZE) | ${SAVINGS}% smaller |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CPU UBI9 | N/A | N/A | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # CUDA C9S comparison (~10GB image)
          GZIP_SIZE=$(get_total_layer_size "$GZIP_CUDA_C9S")
          ZSTD_SIZE=$(get_total_layer_size "$ZSTD_CUDA_C9S")
          if [ "$GZIP_SIZE" -gt 0 ] && [ "$ZSTD_SIZE" -gt 0 ]; then
            SAVINGS=$((100 - (ZSTD_SIZE * 100 / GZIP_SIZE)))
            echo "| CUDA C9S (~10GB) | $(numfmt --to=iec $GZIP_SIZE) | $(numfmt --to=iec $ZSTD_SIZE) | ${SAVINGS}% smaller |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CUDA C9S (~10GB) | N/A | N/A | - |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Benchmark gzip pull (CPU C9S) - cold cache
        run: |
          echo "### Pull Time: gzip CPU C9S (cold)" >> $GITHUB_STEP_SUMMARY
          podman system reset -f 2>/dev/null || true
          START=$(date +%s.%N)
          podman pull "$GZIP_CPU_C9S" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Duration: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          echo "GZIP_CPU_C9S_TIME=$DURATION" >> $GITHUB_ENV

      - name: Benchmark zstd:chunked pull (CPU C9S) - cold cache
        run: |
          echo "### Pull Time: zstd:chunked CPU C9S (cold)" >> $GITHUB_STEP_SUMMARY
          podman system reset -f 2>/dev/null || true
          START=$(date +%s.%N)
          podman pull "$ZSTD_CPU_C9S" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Duration: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          echo "ZSTD_CPU_C9S_TIME=$DURATION" >> $GITHUB_ENV

      - name: Benchmark deduplication - pull UBI9 after C9S (shared base layers)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deduplication Test 1: UBI9 after C9S" >> $GITHUB_STEP_SUMMARY
          echo "Pull UBI9 image after C9S - they share common Python/base layers." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # zstd:chunked test
          podman system reset -f 2>/dev/null || true
          podman pull "$ZSTD_CPU_C9S" --quiet
          echo "### zstd:chunked: Pulling UBI9 after C9S (with layer cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman pull "$ZSTD_CPU_UBI9" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- zstd:chunked UBI9 (warm): **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          
          # gzip test
          podman system reset -f 2>/dev/null || true
          podman pull "$GZIP_CPU_C9S" --quiet
          echo "### gzip: Pulling UBI9 after C9S (with layer cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman pull "$GZIP_CPU_UBI9" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- gzip UBI9 (warm): **${DURATION}s**" >> $GITHUB_STEP_SUMMARY

      - name: Benchmark deduplication - pull CUDA after CPU (shared base layers)
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deduplication Test 2: CUDA after CPU" >> $GITHUB_STEP_SUMMARY
          echo "Pull large CUDA image after CPU - demonstrates savings on shared layers." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # zstd:chunked test
          podman system reset -f 2>/dev/null || true
          podman pull "$ZSTD_CPU_C9S" --quiet
          echo "### zstd:chunked: Pulling CUDA after CPU (with layer cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman pull "$ZSTD_CUDA_C9S" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- zstd:chunked CUDA (warm): **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          
          # gzip test
          podman system reset -f 2>/dev/null || true
          podman pull "$GZIP_CPU_C9S" --quiet
          echo "### gzip: Pulling CUDA after CPU (with layer cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman pull "$GZIP_CUDA_C9S" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- gzip CUDA (warm): **${DURATION}s**" >> $GITHUB_STEP_SUMMARY

      - name: Benchmark large image (CUDA ~10GB) - cold cache
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Large Image Test (CUDA ~10GB) - Cold Cache" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if zstd:chunked CUDA image exists
          if ! crane manifest "$ZSTD_CUDA_C9S" >/dev/null 2>&1; then
            echo "⚠️ **zstd:chunked CUDA image not available** (convert-compression may have failed)" >> $GITHUB_STEP_SUMMARY
            echo "Skipping CUDA benchmarks." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # zstd:chunked CUDA - cold cache
          podman system reset -f 2>/dev/null || true
          echo "### zstd:chunked CUDA pull (cold)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman pull "$ZSTD_CUDA_C9S" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Duration: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          
          # gzip CUDA - cold cache
          podman system reset -f 2>/dev/null || true
          echo "### gzip CUDA pull (cold)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman pull "$GZIP_CUDA_C9S" --quiet
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Duration: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY

      - name: Benchmark build FROM image (cold cache)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build FROM Image Test (cold cache)" >> $GITHUB_STEP_SUMMARY
          echo "Build a simple image that installs cowsay on top of the base image." >> $GITHUB_STEP_SUMMARY
          echo "Each build starts with a fresh podman cache (no pre-pulled layers)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create test Dockerfile
          cat > /tmp/Dockerfile.test << 'DOCKERFILE'
          ARG BASE_IMAGE
          FROM ${BASE_IMAGE}
          RUN pip install --no-cache-dir cowsay && cowsay "Hello from zstd:chunked test!"
          DOCKERFILE
          
          # Build from zstd:chunked base (cold cache - no pre-pulled layers)
          podman system reset -f 2>/dev/null || true
          echo "### Build FROM zstd:chunked base (cold cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman build -f /tmp/Dockerfile.test --build-arg BASE_IMAGE="$ZSTD_CPU_C9S" -t test-zstd:latest /tmp 2>&1 | tail -5
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Build time: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          
          # Build from gzip base (cold cache - no pre-pulled layers)
          podman system reset -f 2>/dev/null || true
          echo "### Build FROM gzip base (cold cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman build -f /tmp/Dockerfile.test --build-arg BASE_IMAGE="$GZIP_CPU_C9S" -t test-gzip:latest /tmp 2>&1 | tail -5
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Build time: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY

      - name: Benchmark build FROM CUDA image (cold cache)
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build FROM CUDA Image Test (~10GB base, cold cache)" >> $GITHUB_STEP_SUMMARY
          echo "Build a simple image with cowsay on top of the large CUDA base image." >> $GITHUB_STEP_SUMMARY
          echo "Each build starts with a fresh podman cache (no pre-pulled layers)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if zstd:chunked CUDA image exists
          if ! crane manifest "$ZSTD_CUDA_C9S" >/dev/null 2>&1; then
            echo "⚠️ **zstd:chunked CUDA image not available** - skipping CUDA build test" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Create test Dockerfile
          cat > /tmp/Dockerfile.test << 'DOCKERFILE'
          ARG BASE_IMAGE
          FROM ${BASE_IMAGE}
          RUN pip install --no-cache-dir cowsay && cowsay "Hello from CUDA test!"
          DOCKERFILE
          
          # Build from zstd:chunked CUDA base (cold cache)
          podman system reset -f 2>/dev/null || true
          echo "### Build FROM zstd:chunked CUDA base (cold cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman build -f /tmp/Dockerfile.test --build-arg BASE_IMAGE="$ZSTD_CUDA_C9S" -t test-cuda-zstd:latest /tmp 2>&1 | tail -5
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Build time: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY
          
          # Build from gzip CUDA base (cold cache)
          podman system reset -f 2>/dev/null || true
          echo "### Build FROM gzip CUDA base (cold cache)" >> $GITHUB_STEP_SUMMARY
          START=$(date +%s.%N)
          podman build -f /tmp/Dockerfile.test --build-arg BASE_IMAGE="$GZIP_CUDA_C9S" -t test-cuda-gzip:latest /tmp 2>&1 | tail -5
          END=$(date +%s.%N)
          DURATION=$(echo "$END - $START" | bc)
          echo "- Build time: **${DURATION}s**" >> $GITHUB_STEP_SUMMARY

      - name: Inspect compression format
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Compression Format Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          get_layer_info() {
            local image="$1"
            MANIFEST=$(crane manifest "$image" 2>/dev/null)
            if echo "$MANIFEST" | jq -e '.manifests' >/dev/null 2>&1; then
              DIGEST=$(echo "$MANIFEST" | jq -r '.manifests[0].digest')
              REPO=$(echo "$image" | cut -d@ -f1 | cut -d: -f1)
              crane manifest "${REPO}@${DIGEST}" 2>/dev/null | jq '.layers[:3][] | {mediaType, size: (.size | . / 1048576 | floor | tostring + " MB")}'
            else
              echo "$MANIFEST" | jq '.layers[:3][] | {mediaType, size: (.size | . / 1048576 | floor | tostring + " MB")}'
            fi
          }
          
          echo "### zstd:chunked image layers (first 3)" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          get_layer_info "$ZSTD_CPU_C9S" >> $GITHUB_STEP_SUMMARY || echo "Could not inspect layers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "### gzip image layers (first 3)" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          get_layer_info "$GZIP_CPU_C9S" >> $GITHUB_STEP_SUMMARY || echo "Could not inspect layers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Cold cache tests show raw pull performance" >> $GITHUB_STEP_SUMMARY
          echo "- Deduplication tests show benefit when pulling related images" >> $GITHUB_STEP_SUMMARY
          echo "- On high-bandwidth CI (>100Mbps), partial pulls may be slower due to HTTP range request overhead" >> $GITHUB_STEP_SUMMARY
          echo "- Real benefits materialize with: layer caching, low-bandwidth, or lazy loading" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [ADR-0005](docs/architecture/decisions/0005-zstd-chunked-compression-for-base-images.md) for details." >> $GITHUB_STEP_SUMMARY
