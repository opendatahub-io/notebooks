---
name: Sync branches through Pull Request

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      source:
        description: Source branch
        required: true
      target:
        description: Target branch
        required: true

jobs:
  sync:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.target }}
          fetch-depth: 0

      - name: Prepare sync branch
        id: prepare
        run: |
          git fetch origin ${{ github.event.inputs.source }}
          git reset --hard origin/${{ github.event.inputs.source }}

          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          SYNC_BRANCH=sync__${{ github.event.inputs.source }}__${{ github.event.inputs.target }}__${TIMESTAMP}
          echo "branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT

      - name: Create pull request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725  # v8.0.0
        with:
          branch: ${{ steps.prepare.outputs.branch }}
          title: "Sync `${{ github.event.inputs.target }}` branch with `${{ github.event.inputs.source }}` branch"
          body: |
            :robot: This is an automated Pull Request created by `/.github/workflows/sync-branches-through-pr.yml`.

            It merges all commits from `${{ github.event.inputs.source }}` branch into `${{ github.event.inputs.target }}` branch.

            :warning: **IMPORTANT NOTE**: Remember to delete the `${{ steps.prepare.outputs.branch }}` branch after merging the changes.

  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Encrypt git-crypt key with recovery passphrase
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
          GIT_CRYPT_KEY_RECOVERY: ${{ secrets.GIT_CRYPT_KEY_RECOVERY }}
        run: |
          set -euo pipefail

          if [ -z "${GIT_CRYPT_KEY}" ]; then
            echo "::error::GIT_CRYPT_KEY secret is not set"
            exit 1
          fi
          if [ -z "${GIT_CRYPT_KEY_RECOVERY}" ]; then
            echo "::error::GIT_CRYPT_KEY_RECOVERY secret is not set"
            exit 1
          fi

          echo "${GIT_CRYPT_KEY}" | base64 -d > git-crypt-key.bin
          echo "${GIT_CRYPT_KEY_RECOVERY}" | \
            openssl enc -aes-256-cbc -salt -pbkdf2 -iter 600000 \
              -in git-crypt-key.bin \
              -out git-crypt-key.enc \
              -pass stdin
          rm -f git-crypt-key.bin

      - name: Upload encrypted key as artifact
        uses: actions/upload-artifact@v4
        with:
          name: git-crypt-key-backup-${{ github.run_id }}
          path: git-crypt-key.enc
          retention-days: 3
