######################################################
# mongocli-builder (build stage only, not published) #
######################################################

FROM registry.access.redhat.com/ubi9/go-toolset:latest AS mongocli-builder

ARG MONGOCLI_VERSION=2.0.4

WORKDIR /tmp/

{% if arch == 's390x' -%}

    # Keep s390x special-case from original (create dummy binary) but
    # include explicit curl/unzip steps from the delta for non-s390x.
    RUN mkdir -p /tmp && printf '#!/bin/sh\necho "mongocli not supported on s390x"\n' > /tmp/mongocli && \
        chmod +x /tmp/mongocli

{% else -%}

    RUN curl -Lo mongodb-cli-mongocli-v${MONGOCLI_VERSION}.zip https://github.com/mongodb/mongodb-cli/archive/refs/tags/mongocli/v${MONGOCLI_VERSION}.zip && \
        unzip ./mongodb-cli-mongocli-v${MONGOCLI_VERSION}.zip && \
        cd ./mongodb-cli-mongocli-v${MONGOCLI_VERSION}/ && \
        CGO_ENABLED=1 GOOS=linux GOARCH=${arch} GO111MODULE=on go build -a -tags strictfipsruntime -o /tmp/mongocli ./cmd/mongocli/

{% endif -%}
